<!DOCTYPE html>
<html>

  <head>

    <title>Flight routes</title>


    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <!-- leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="L.Hotline.js"></script>


    <!-- datasets -->
    <script src="diverging_routes.js"></script>
    <script src="std_routes.js"></script>
    <script src="airports.js"></script>


    <!-- app -->
    <script>
      $(function () {
        var map_diverging = L.map('map-diverging').setView([50,10.5], 4).addLayer(
          L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            minZoom: 2,
            maxZoom: 14,
            attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        }));
        var map_fuel = L.map('map-fuel').setView([50,10.5], 4).addLayer(
          L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            minZoom: 2,
            maxZoom: 14,
            attribution: 'Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        }));
        var map_diverging_layer = null;
        var map_fuel_layer = null;

        // removing empty diverging routes
        diverging_routes = diverging_routes.filter(function (routes) {return routes.routes.length > 0;});

        // trick to fix the layout
        $("body").on('shown.bs.tab', function() { 
          map_diverging.invalidateSize(false);
          map_fuel.invalidateSize(false);
        });

        // filling combo boxes
        diverging_routes
          .map(function (route) {
            return route.airports.departureCode;
          })
          .filter(function (value, index, self) { 
            return self.indexOf(value) === index;
          })
          .sort()
          .map(function (code) {
            var name = airports
                          .filter(function (airport) {return airport[4] === code})
                          .pop()[1];
            return [code, name];
          })
          .forEach(function (airport) {
            var select = document.getElementById('select-departure-diverging');
            var opt = document.createElement('option');
            opt.value = airport[0];
            opt.innerHTML = airport[0] + ' - ' + airport[1];
            select.appendChild(opt);
          });

        std_routes
          .map(function (route) {
            return route.airports.departureCode;
          })
          .filter(function (value, index, self) { 
            return self.indexOf(value) === index;
          })
          .sort()
          .map(function (code) {
            var name = airports
                          .filter(function (airport) {return airport[4] === code})
                          .pop()[1];
            return [code, name];
          })
          .forEach(function (airport) {
            var select = document.getElementById('select-departure-fuel');
            var opt = document.createElement('option');
            opt.value = airport[0];
            opt.innerHTML = airport[0] + ' - ' + airport[1];
            select.appendChild(opt);
          });

        // departure selected
        $('#select-departure-diverging').change(function () {
          var select = document.getElementById('select-arrival-diverging');
          var departure = this.value;

          if (!departure) {
            select.innerHTML = '';
            return;
          }

          select.innerHTML = '<option value="">Choose an airport</option>';

          diverging_routes
            .filter(function (route) {
              return route.airports.departureCode === departure;
            })
            .map(function (route) {
              return route.airports.arrivalCode;
            })
            .filter(function (value, index, self) { 
              return self.indexOf(value) === index;
            })
            .sort()
            .map(function (code) {
              var name = airports
                            .filter(function (airport) {return airport[4] === code})
                            .pop()[1];
              return [code, name];
            })
            .forEach(function (airport) {
              var opt = document.createElement('option');
              opt.value = airport[0];
              opt.innerHTML = airport[0] + ' - ' + airport[1];
              select.appendChild(opt);
            });
        });
        $('#select-departure-fuel').change(function () {
          var select = document.getElementById('select-arrival-fuel');
          var departure = this.value;

          if (!departure) {
            select.innerHTML = '';
            return;
          }

          select.innerHTML = '<option value="">Choose an airport</option>';

          std_routes
            .filter(function (route) {
              return route.airports.departureCode === departure;
            })
            .map(function (route) {
              return route.airports.arrivalCode;
            })
            .filter(function (value, index, self) { 
              return self.indexOf(value) === index;
            })
            .sort()
            .map(function (code) {
              var name = airports
                            .filter(function (airport) {return airport[4] === code})
                            .pop()[1];
              return [code, name];
            })
            .forEach(function (airport) {
              var opt = document.createElement('option');
              opt.value = airport[0];
              opt.innerHTML = airport[0] + ' - ' + airport[1];
              select.appendChild(opt);
            });
        });


        // arrival selected
        $('#select-arrival-diverging').change(function () {
          if (map_diverging_layer) {
            map_diverging_layer.remove();
            map_diverging_layer = null;
          }

          map_diverging_layer = L.layerGroup().addTo(map_diverging);

          var departure = document.getElementById('select-departure-diverging').value;
          var arrival = this.value;

          if (!departure || !arrival)
            return;

          // plot std route
          var route = std_routes.filter(function (route) {
              return route.airports.departureCode === departure &&
                       route.airports.arrivalCode === arrival;
          }).pop();

          if (!route)
            return;

          var coords = route.route.map(function (point) {
                                return [point.lat/10, point.lon/10]
                              });
          var options = {
            color: 'blue', smoothFactor: 1
          };

          L.polyline(coords, options).addTo(map_diverging_layer);

          // plot diverging routes

          var routes = diverging_routes.filter(function (routes) {
              return routes.airports.departureCode === departure &&
                       routes.airports.arrivalCode === arrival;
          }).pop();

          if (!routes)
            return;

          routes.routes.forEach(function (route) {
            var coords = route.map(function (point) {
                            return [point.lat/10, point.lon/10]
                          });
            var options = {
              color: 'red',
              smoothFactor: 1
            };

            L.polyline(coords, options).addTo(map_diverging_layer);
          });

        });

        $('#select-arrival-fuel').change(function () {
          if (map_fuel_layer) {
            map_fuel_layer.remove();
            map_fuel_layer = null;
          }

          map_fuel_layer = L.layerGroup().addTo(map_fuel);

          var departure = document.getElementById('select-departure-fuel').value;
          var arrival = this.value;

          if (!departure || !arrival)
            return;

          var route = std_routes.filter(function (route) {
              return route.airports.departureCode === departure &&
                       route.airports.arrivalCode === arrival;
          }).pop();

          if (!route)
            return;

          var destination = route.route.slice(-1).pop();

          // plot straight line
          var options = {
            color: 'black',
            smoothFactor: 1
          };
          var points = [
            [route.route[0].lat/10, route.route[0].lon/10],
            [destination.lat/10, destination.lon/10]
          ];

          L.polyline(points, options).addTo(map_fuel_layer);

          // plot hotline
          var coords = route.route.map(function (point, idx, arr) {
            var angle = 0;
            if (idx+2 < arr.length) {
              var A = point;
              var B = arr[idx+1];
              var C = destination;
              var AB = Math.sqrt(Math.pow(B.lat-A.lat,2) + Math.pow(B.lon-A.lon,2));
              var BC = Math.sqrt(Math.pow(B.lat-C.lat,2) + Math.pow(B.lon-C.lon,2));
              var AC = Math.sqrt(Math.pow(C.lat-A.lat,2) + Math.pow(C.lon-A.lon,2));
              angle = Math.floor(Math.acos((BC*BC+AB*AB-AC*AC)/(2*BC*AB))*180/3.14159265359);
              angle = Math.abs(angle-180)
            }
            return [point.lat/10, point.lon/10, angle]
          });

          console.log(coords);

          L.hotline(coords, {
            min: 0,
            max: 180,
            palette: {
              0.0: '#008800',
              0.5: '#ffff00',
              1.0: '#ff0000'
            },
            weight: 5,
            outlineColor: '#000000',
            outlineWidth: 1
          }).addTo(map_fuel_layer);

        });

      });
    </script>
  </head>

  <body>
    <div class="container">
      <div class="jumbotron">
        <h1>Flight routes</h1>
        <p>An interactive data visualization</p>
      </div>
      <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#div-main">Home</a></li>
        <li><a data-toggle="tab" href="#div-diverging">Abnormal routes</a></li>
        <li><a data-toggle="tab" href="#div-fuel">Fuel saving</a></li>
      </ul>

      <div class="tab-content">

        <div id="div-main" style="padding: 1em 0em;" class="tab-pane fade active in">
          <h3>HOME</h3>
          <p>Some content.</p>
        </div>

        <div id="div-diverging" style="padding: 1em 0em;" class="tab-pane fade">

          <div class="row">
            <div class="col-xs-4">
              <select id="select-departure-diverging" class="form-control" name="airport-diverging">
                <option value="">Choose an airport</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-xs-4">
              <select id="select-arrival-diverging" class="form-control" name="airport-diverging">
              </select>
            </div>
          </div>

          <div class="row">
            <div id="map-diverging" style="height: 600px; margin: 1em;"></div>
          </div>

        </div>

        <div id="div-fuel" style="padding: 1em 0em;" class="tab-pane fade">

          <div class="row">
            <div class="col-xs-4">
              <select id="select-departure-fuel" class="form-control" name="airport-fuel">
                <option value="">Choose an airport</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-xs-4">
              <select id="select-arrival-fuel" class="form-control" name="airport-fuel">
              </select>
            </div>
          </div>

          <div class="row">
            <div id="map-fuel" style="height: 600px; margin: 1em;"></div>
          </div>
        </div>

      </div>
    </div>

  </body>

</html>